<!doctype html>
<html>
  <head>
    <!-- bootstrap css & js-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <title>OneVasc</title>

    <script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
  crossorigin="anonymous"></script>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function(){
        const queryString = window.location.search;
        console.log("Query string", queryString);

        const urlParams = new URLSearchParams(queryString);
        const iframe_url = urlParams.get('iframe_url');
        
        if(iframe_url != undefined && iframe_url != "") {
          console.log("iframe url parameter", iframe_url);
          document.getElementById("onevasc").src = iframe_url;
        }

        const inputElement = document.getElementById("loadState");
        inputElement.addEventListener("change", loadOnevFile, false);
        function loadOnevFile() {
          const file = this.files[0];

          const reader = new FileReader();
          reader.onload = (e) => {
            sendOnevascMessage("loadOnev", e.target.result);
          };
          reader.readAsText(file);
        }
      });

      function getQueryVariable(name) {
        var qs = window.location.search.substring(1);
        var v = qs.split('&');
        for (var i=0;i<v.length;i++) {
          var p = v[i].split('=');
          if (p['0'] == name) { return p['1']; }
        }
        return null;
      }
        
        addEventListener("message", listener, false);
        async function listener(e) {
          try {
            // The event object should contain a stringified iframe_message object
            let msg = JSON.parse(e.data);

            // Exit the callback if the message is not coming from the OneVasc API
            if(!msg.onevasc)
              return;

            //alert("message received (origin="+e.origin+"): "+JSON.stringify(msg));
            console.log("iframe message received", msg);

            // Display all received messages in this element
            $('#state')[0].innerText = e.data;

            if( msg.command == "onevError") {
              alert("Received onevasc error message")
              console.error("onev iframe error", msg);
            }
            // Handling the save button, visible or not, disabled or not
            else if(msg.command == "saveContextChange") {
              if(msg.data.schemaVisible)
                $('#saveStateBtn')[0].classList.remove("d-none");
              else
                $('#saveStateBtn')[0].classList.add("d-none");

              if(msg.data.unsavedChanges)
                $('#saveStateBtn')[0].removeAttribute("disabled");
              else
                $('#saveStateBtn')[0].setAttribute("disabled", true);
            }
            else if(msg.command == "generateAIText") {
              $('#state')[0].innerText = msg.data.text;
            }
            else if( msg.command == "savePdf" )
            {
              var link = document.createElement("a");

              document.body.appendChild(link); // for Firefox

              link.setAttribute("href", msg.data);
              link.setAttribute("download", "document.pdf");
              link.click();
              await new Promise((resolve) => setTimeout(resolve, 5250));
            }
            else if( msg.command == "saveJpeg" )
            {
              var link = document.createElement("a");

              document.body.appendChild(link); // for Firefox

              link.setAttribute("href", msg.data);
              link.setAttribute("download", "image.jpeg");
              link.click();
              await new Promise((resolve) => setTimeout(resolve, 5250));
            }
            else if( msg.command == "savePng" )
            {
              var link = document.createElement("a");

              document.body.appendChild(link); // for Firefox

              link.setAttribute("href", msg.data);
              link.setAttribute("download", "image.png");
              link.click();
              await new Promise((resolve) => setTimeout(resolve, 5250));
            }

            else if(msg.command == "onevLoginRequest") {
              let username = getQueryVariable("username") ?? prompt("Please enter your login", "");
              let pwd = getQueryVariable("password") ?? prompt("Please enter your password", "");

              sendOnevascMessage( "onevLoginWithCredentials", {
                username: username,
                password: pwd
              });
            }

            else if( msg.command == "getInjuries") {
              console.log("getInjuries response", msg.data);
            }
            else if( msg.command == "onevReady") {
              // When ready is received, show the iframe
              $('#onevasc')[0].setAttribute('style', 'display:inherit');

              // Example of stent information
              sendOnevascMessage( "setStents", [
                {
                  name: "iframe test 1",
                  diameter: 5,
                  length: 123
                },
                {
                  name: "iframe test 2",
                  diameter: 7,
                  length: 124
                },
                {
                  name: "iframe test 3",
                  diameter: 7
                },
                {
                  name: "iframe test 4",
                  length: 42
                }
              ]);
            }
          }
          catch(e)
          {}
        }
        
        function sendOnevascMessage(cmd, data = "") {
            $('#onevasc')[0].contentWindow.postMessage(JSON.stringify({ onevasc: true, command: cmd, data: data }), '*')
        }

        function sendOnevascSavePdfMessage() {
            $('#onevasc')[0].contentWindow.postMessage(JSON.stringify({ onevasc: true, command: 'savePdf' }), '*')
        }
    </script>

  </head>
  <body>

    <div class="container-fluid"></div>
      <div class="row">
        <div class="col col-10 order-9">
          <iframe style="display:none" id="onevasc" src="https://vasc-map.firebaseapp.com/loadexam/3sVdt07gOhaKKJZzKV6A" height="1000" width="100%" title="Onevasc"></iframe>
        </div>
        <div class="col col-2">
          <p>Onev content :</p>
          <textarea id="onevcontent">
          </textarea>
          <p>Create object :</p>
          <textarea id="newobj">
          </textarea>
          <button id="newObj" onClick="sendOnevascMessage('createObject', JSON.parse($('#newobj')[0].value));">Send object</button>
          <button id="logoutBtn" onClick="sendOnevascMessage('logout');">Logout</button>
          <button id="saveStateBtn" class="d-none" onClick="sendOnevascMessage('saveOnev');">Save ONEV</button>
          <button id="loadStateBtn" onClick="sendOnevascMessage('loadOnev', $('#onevcontent')[0].value);">Load ONEV</button>
          <input type="file" id="loadState" name="loadonev" accept=".onev" />
          <input id="imageQuality" value="2"/>
          <button id="getPngBtn" onClick="sendOnevascMessage('savePng', {quality:Number($('#imageQuality')[0].value)});">Get PNG data</button>
          <button id="getJPegBtn" onClick="sendOnevascMessage('saveJpeg', {quality:Number($('#imageQuality')[0].value)});">Get JPEG data</button>
          <button id="getJPegBtn" onClick="sendOnevascMessage('saveJpeg', {quality:Number($('#imageQuality')[0].value), mode: 'schema-only'});">Get JPEG schema-only</button>
          <button id="getPdfBtn" onClick="sendOnevascSavePdfMessage();">Get PDF data</button>
          <button id="getInjuriesBtn" onClick="sendOnevascMessage('getInjuries');">Get Injuries</button>
          <button id="message array" onClick="sendOnevascMessage('messageArray');">Message array with no message (error)</button>
          <button id="message array" onClick="sendOnevascMessage('messageArray', [{ command: 'saveOnev'}, { command: 'saveJpeg'}]);">Message array</button>
          <button id="generateAIText" onClick="sendOnevascMessage('generateAIText');">AI Text (default opts)</button>
          <button id="generateAIText" onClick="sendOnevascMessage('generateAIText', {options: {mode: 'ConclusionOnly'}});">AI Text (conclusion only)</button>
          <button id="generateAIText" onClick="sendOnevascMessage('generateAIText', {options: {aiModel: 'gemini-2.5-pro'}});">AI Text (pro model)</button>
          <button id="generateAIText" onClick="sendOnevascMessage('generateAIText', {options: {aiModel: 'gemini-NOEXIST-pro'}});">AI Text (invalid model, error)</button>
          <p id="state"></p>
        </div>
      </div>
</html>
